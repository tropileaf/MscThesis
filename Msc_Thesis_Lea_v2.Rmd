---
title: "Cross-sectoral conservation of the Indian Ocean"
author: "Lea Fourchault"
date: "08/03/2022"
output: 
 html_document:
    toc: true
    toc_float: true
 
---
<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 34px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 24px;
  color: Black;
}
h2 { /* Header 2 */
    font-size: 20px;
  color: Black;
}
h3 { /* Header 3 */
  font-size: 14px;
  color: Black;
}
code.r{ /* Code block */
    font-size: 11px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
---

Resolved questions:

+ how to group all files (ex: all EBSAs + IBAs + IMMAs + vents + seamounts...) into one, to create ConsFeatures? Or is it enough to have columns next to PUs? RESOLVED: yes, stacking = creating columns next to PUs.
+ should we use Sharma (2011) + CRU Consulting (2019) to assign USD values to PMN areas? see PMN subsection. RESOLVED, yes, can use for this project (need to cross-check if want to publish)
+ shipping raster : cells have certain values (# of ships recorded?? I can't figure from the attached files, metadata is confusing), could allow to infer USD value of route (# of ships * approx cost of fuel for average cargo to go through 1 PU, which is 1000sqkm)? So we wouldn't try to compute the cost of deviating from any given route, but rather compute the price for each ship to go through 1 PU * the number of ships going through that PU. It sounds fairly logical to me, but maybe it's not? RESOLVED: check 2008 metada, run prio problem with only shipping
+ fishing cost layer : there is a ready-made fx in SpatPlan repo (thanks Jase & Tin), should we use it for this project? see fishing subsection (but issues with plotting  as you can see). RESOLVED: yes, use fx from Jase & Tin. Change scale to remove outliers/crop to planning region.
+ I'm using echo = FALSE, message = FALSE, warning = FALSE, results = "hide" and still can't get rid of some coding output in the .html. RESOLVED: cut up chuncks of code with separate ones for plots
+ I st_to_sf the vents from .csv with PUs' crs but have some issues intersecting the points with polygs, will look more into it. RESOLVED: use st_contains after crs = 4326 & st_transform(cCRS)
+ add list of species as cons_feats: EN, VU etc (Ant's email to mining colleague)? RESOLVED: fine-tune later
+ shipping raster (Halpern et al., 2015) is too heavy to be converted to polygon, what could be other methods (not using as.polygon)? RESAMPLE if resolution <1°. Resolution = 934m*934m (! 1° at equator = 111km = 60 nm; [convert](https://www.johndcook.com/how_big_is_a_degree.html); resolution too fine so need resampling). RESOLVED: no resampling, overlay raster with PUs (exactextractr) to attribute mean raster cells value to PUs (no weighted mean because raster cells are all equal-area because Mollweide proj)
+ how to remove EEZs from PUs? RESOLVED: find EEZ shp and spatial predicates, inverse overlay with Bndry, recreate PUs
+ setting  targets. RESOLVED: 30% for rpz area, 70% for important/rare feature; create dataframe with 1 column: features, 1 column: targets (match order)
+ *cross inactive vents & PUs - done*
+ check research questions. RESOLVED keep Ant's questions
+ Error in h(simpleError(msg, call)) : error in evaluating the argument 'x' in selecting a method for function 'add_relative_targets': error in evaluating the argument 'features' in selecting a method for function 'problem': object 'Cons_feats' not found. RESOLVED: use string: features = "x", "y"; instead of creating Cons_feats tibble
+ cannot install lpsymphony: almost compiled but failed because did not find directory for gfortran AND see this link: issues with Mojave https://www.cynkra.com/blog/2021-03-16-gfortran-macos/ : brew and gfortran cask deprecated since 2021 (still work if installed before but i didn't). RESOLVED: install Gurobi using student email
+ PUs: when mutating FishingCost column to PUs, creates duplicate of 'geometry' column called 'Fishing.geometry'. RESOLVED don't forget to add dataframe: dataframeDOLLARcolumn name: PUs <- PUs %>% mutate(Fishing = FishingCost$FishingCost)
+ *create new PUs with ABNJ only - done but check method*, methodology not checked
+ general bugs to run code on .rmd file. Use knitr::spin instead. I also replaced the initial chunk with ```{r setup, include=FALSE} knitr::opts_chunk$set(echo = TRUE)``` but no result, maybe need to reinstall r and r studio

---

Current questions & updates:


+ ongoing - pricing deep-sea mineral resources: for CFC *we know the area based on Crust.shp; we know CFC mean specific-surface areas = 325 m2/g (Hein et al., 2000; found in Hein et al., 2013) -> can find tonnage; then, we know chemical composition of CFC in Indian Ocean (given in wt% or ppm=g/tonne, for ex: 392 Mo ppm; Fe=22wt% - see Hein, 2014 or Petersen et al., 2016) -> can multiply by CFC tonnage to get tonnage for each mineral; then multiply by market prices (mean over 5 yrs?) to estimate total value of CFC in Indian Ocean?*
+ I have emailed Dr. Mizell about her calculations of CFC tonnage for the Indian Ocean (paper only gives global tonnage)

*Coding questions, will think about it some more*

+ how to assign price to mining shps / create mining cost layer once value of deep-sea resources is computed?
+ overlay shipping & PUs + plot with log10: partly resolved using exact_extractr but issues with +1 and log10 and when plotting PUxShipping: not a map but a scatterplot; issues with transformation/reprojection?

--- 

Parameters we agree on for first prioritizr run

+ PUs = ABNJ only
+ cons_feats = IMMAs, IBAs, chosen EBSAs, vents (active + inactive), seamounts, plateaus; no aquamaps
+ PMN mining value = value/t * density * area, discount rate and other improvements to be determined later (if any), USD
+ fishing cost = removed fish mass * fish value (layer created by Jase), USD
+ shipping cost = mean of shipping raster cells' values for each PU using exact_extracr, not USD (intensity) OR SHOULD WE USE SHIPPING AS A PENALTY?
+ targets = 30% for rpz area, 70% for important/rare feature

---


# Introduction

**Aim**

*This project aims to identify areas for MPAs that maximise the conservation of biologically and ecologically important areas in the Indian Ocean's ABNJS, across all depths, while minimizing conflict with local industrial stakeholders - including the fishing, shipping, and deep-sea mining industries.*

**Current research questions**

1. How can future seabed mining be included in spatial planning?
2. What is the potential spatial overlap among biodiversity, fishing, shipping and seabed mining in the Indian Ocean high seas?
3. Where could we place reserves in the Indian Ocean high seas that meet conservation objectives whilst minimsing conflict with fishing and seabed mining? 

Why ABNJs?

+ to reach the global target of 30% marine protection, ABNJs are optimal (largest area; common good: higher incentive to protect since lower opportunity cost for individual countries)
+ but maybe we can also include non ABNJ? (because shipping data more interesting in EEZs, tbd later)

Why the Indian Ocean?

+ numerous ecosystems providing important services and unique biodiversity, but few already existing MPAs within EEZs and none in ABNJs
+ active exploration of PMN & CFC for deep sea mining but no plan for conservation linked to deep-sea mining (unlike Pacific)
+ many stakeholders present (increasingly dense shipping routes, fishing activity, deep-sea mining): higher risk of conflict: prioritization approach should be useful

Why considering all depth layers? 

+ despite unique biodiversity, the deep sea is often ignored in MPA design
+ the deep sea increasingly at risk from anthropogenic disturbances
+ we need to consider all layers to ensure vertical connectivity
+ the implementation of MPAs is only feasible on surface level (makes no sense to focus only on deep-sea, even if major preoccupation is benthic or at high depth).

Why considering multiple stakeholders?

+ so far, most MPA design is based on the fishing industry alone (despite some rather unsuccessful attempts to include tourism or other industries)
+ deep-sea mining has not yet been considered in MPA design by prioritization, despite major foreseen impacts on marine biodiversity
+ shipping routes (cargo, tankers, tourism) also disturb marine fauna, especially charismatic megafauna

```{r, echo = FALSE, results = "hide", message = FALSE}
#Open all the packages and get extras
options(repos = list(CRAN="http://cran.rstudio.com/")) 
library(tidyverse)
library(sf)
library(patchwork)
library(terra)
library(stars)
library(rnaturalearth)
library(rnaturalearthdata)
library(prioritizr)
library(knitr)

source("SpatPlan_Extras.R")

fSpatPlan_Get_Polyg <- function(filen, PUs){
  
  polyg_crs <- st_crs(PUs)
  Polyg1 <- st_read(filen) %>% 
    st_transform(polyg_crs) 
  
  Polyg1PUs <- PUs %>% 
    st_centroid() %>% #Second, get all the PUs with < 50 % area on land #?
    st_within(Polyg1, sparse = FALSE) %>% 
    rowSums() %>%
    as.logical()
  
  # Polyg1PUs <- PUs %>% 
  #   mutate(locked_in = Polyg1PUs) ##assign new column to PUs (call it name of shp)
  # 
  return(Polyg1PUs)
}
```

# Materials and Methods

## Prioritizr workflow

Inputs needed:

+ planning region & PUs
+ conservation features & conservation targets
+ cost layer

## Layers overview

blue habitats do not include hydro vents, so will use Beaulieu & Szanfranski (2020) [link](https://doi.pangaea.de/10.1594/PANGAEA.917894?format=html#download)


Input type   |  Topic                 | Reference/source (format)
:-----------:|:----------------------:|:----------------------------------:
 COST        |  Expl + Res (mining)   |  ISA (shp)
 COST        |  PMN & CFC (mining)    |  Petersen et al., 2016 (shp)
 COST        |  Shipping              |  Halpern et al., 2015 (tif from 2013)
 COST        |  Fishing               |  Cost layer created by Jase
 CONS        |  IBAs                  |  Birdlife datazone (shp)
 CONS        |  IMMAs                 |  importantmarinemammalhabitat (shp)
 CONS        |  EBSAs                 |  CBD (shp)
 CONS        |  Benthic features      |  Blue Habitats (shp)
 CONS        |  Longhurst provinces ? |  Marine Regions (shp)
 CONS        |  Active vents          |  Beaulieu & Szanfranski (2020) (csv)
 CONS        |  Inactive vents        |  Beaulieu & Szanfranski (2020) (csv)
 
## Planning region 

*substract EEZs shp from boundary, then recreate PUs*

```{r Planning Region, echo = TRUE, message = FALSE, results = "hide", warning = FALSE}

# define region and boundary

cCRS <- "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs" # Robinson projection
world <- ne_countries(scale = "medium", returnclass = "sf") %>% 
  st_transform(cCRS)
#Region <- c(xmin = 18, xmax = 140, ymin = -39, ymax = 34) 
Region <- c(xmin = 20, xmax = 120, ymin = -60, ymax = 20) 
# Indian Ocean limits: CIA World Factbook (but see: According to the International Hydrographic Organization (IHO) and the United Nations Oceans Atlas, the area from 40°S latitude to 60°S latitude is included in the Indian Ocean. The area that encircles the globe from 60°S latitude to the coast of Antarctica is called The Great Southern Ocean. The Indian Ocean's width extends from 45° E longitude to 110°East longitude.) Also, Region has big impact on final plan because fishing cost is much lower as latitude increases towards south pole
Bndry <- fSpatPlan_Get_Boundary(Region, cCRS) # boundary

# intersect bndry and high seas

ABNJ <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/World_High_Seas_v1/High_Seas_v1.shp") 
ABNJRobin <- st_transform(ABNJ, cCRS) # high seas in robin proj, does not work when using pipe
ABNJRobBuff  <- st_buffer(ABNJRobin, 0) # need to create buffer of 0 to avoid Error in CPL_geos_op2(op, x, y) : Evaluation error: TopologyException: Input geom 0 is invalid: Self-intersection at or near point -> overwrite offending geometries
BndryABNJ <- st_intersection(ABNJRobBuff, Bndry)

#create PUs

PU_size <- 1000 # in km2, but check resolution for this project?
Shape <- "Hexagon" # shape of PUs
MinDepth <- 0
MaxDepth <- 200 # but check for deep-sea?
PUs <- fSpatPlan_Get_PlanningUnits(BndryABNJ, world, PU_size, Shape) 

### method with EEZ took forever and was not created the PUs I wanted, so I chose to keep high seas shp instead of using EEZ shp
#EEZ <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Data/World_EEZ_v11/eez_v11.shp") 
#EEZRobin <-  st_transform(EEZ, cCRS)
#BndryABNJ <- st_difference(Bndry, EEZRobin)
#PUs <- fSpatPlan_Get_PlanningUnits(Bndry, world, PU_size, Shape) # error : st_crs(x) == st_crs(y) is not TRUE ?
```

Planning Units
```{r PUs, echo=FALSE}
(ggPU <- fSpatPlan_PlotPUs(PUs, world)) # Plot Planning Units
```

## Conservation features & targets

Composed of 

+ Important Bird Areas
+ Important Marine Mammal Areas
+ EBSAs
+ Deepsea features: active + inactive vents, seamounts, plateaus

### Important Bird Areas

Conservation targets = 30%

```{r IBAs, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}

#loading file 
IBA <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/IBAs/MarineIBA_IndianOcean.shp"

#crossing shp & PUs
PUxIBA <- fSpatPlan_Get_Polyg(IBA, PUs)  
PUs <- PUs %>% 
  mutate(IBA = PUxIBA) #add column to PU table with
```

### Important Marine Mammal Areas

Conservation targets = 30%

```{r IMMAs, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}

#loading file
IMMA <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/IMMAs/iucn-imma.shp"

#crossing shp & PUs
PUxIMMA <- fSpatPlan_Get_Polyg(IMMA, PUs)  
PUs <- PUs %>% 
  mutate(IMMA = PUxIMMA)
```

### Ecologically and Biologically Significant Areas

Chosen to be:

+ within ABNJs (at least partially)
+ not redundant with IMMAs or IBAs

Targets: *need to write chunck*

+ NEIO_09 : 30%
+ NWIO_14 : 30%
+ SIO_11 :  30%
+ SIO_19 :  70%
+ SIO_22 :  70%
+ SIO_23 :  70%
+ SIO_30 :  70%
+ SIO_32 :  70%
+ SIO_35 :  70%
+ SIO_36 :  70%
+ SIO_37 :  70%

```{r EBSAs, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}

NEIO_09<- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/NEIO_9_EBSA/NEIO_9_EBSA.shp"
PUxNEIO_09 <- fSpatPlan_Get_Polyg(NEIO_09, PUs)  
PUs <- PUs %>% 
  mutate(NEIO_09 = PUxNEIO_09)

NWIO_14 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/NWIO_14_EBSA/NWIO_14_EBSA.shp"
PUxNWIO_14 <- fSpatPlan_Get_Polyg(NWIO_14, PUs)  
PUs <- PUs %>% 
  mutate(NWIO_14 = PUxNWIO_14)

SIO_11 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_11_EBSA-GIS shapefile/SIO_11_EBSA.shp"
PUxSIO_11 <- fSpatPlan_Get_Polyg(SIO_11, PUs)  
PUs <- PUs %>% 
  mutate(SIO_11 = PUxSIO_11)

SIO_19 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_19_EBSA-GIS%20shapefile/SIO_19_EBSA.shp"
PUxSIO_19 <- fSpatPlan_Get_Polyg(SIO_19, PUs)  
PUs <- PUs %>% 
  mutate(SIO_19 = PUxSIO_19)

SIO_22 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_22_EBSA-GIS shapefile/SIO_22_EBSA.shp"
PUxSIO_22 <- fSpatPlan_Get_Polyg(SIO_22, PUs)  
PUs <- PUs %>% 
  mutate(SIO_22 = PUxSIO_22)

SIO_23 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_23_EBSA-GIS shapefile/SIO_23_EBSA.shp"
PUxSIO_23 <- fSpatPlan_Get_Polyg(SIO_23, PUs)  
PUs <- PUs %>% 
  mutate(SIO_23 = PUxSIO_23)

SIO_30 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_30_EBSA-GIS shapefile/SIO_30_EBSA.shp"
PUx_SIO30 <- fSpatPlan_Get_Polyg(SIO_30, PUs)  
PUs <- PUs %>% 
  mutate(SIO_30 = PUx_SIO30)

SIO_32 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_32/SIO_32_EBSA.shp"
PUxSIO_32 <- fSpatPlan_Get_Polyg(SIO_32, PUs)  
PUs <- PUs %>% 
  mutate(SIO_32 = PUxSIO_32)

SIO_35<- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_35_EBSA-GIS shapefile/SIO_35_EBSA.shp"
PUxSIO_35 <- fSpatPlan_Get_Polyg(SIO_35, PUs)  
PUs <- PUs %>% 
  mutate(SIO_35 = PUxSIO_35)

SIO_36 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_36_EBSA-GIS shapefile/SIO_36_EBSA.shp"
PUxSIO_36 <- fSpatPlan_Get_Polyg(SIO_36, PUs)  
PUs <- PUs %>% 
  mutate(SIO_36 = PUxSIO_36)

SIO_37  <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_37_EBSA-GIS shapefile/SIO_37_EBSA.shp"
PUx_SIO37 <- fSpatPlan_Get_Polyg(SIO_37 , PUs)  
PUs <- PUs %>% 
  mutate(SIO_37 = PUx_SIO37)
```

### Deep-sea features

Seamounts, plateaus, inactive + active vents

+ Active + inactive vents: 70% [.csv to .shp](https://datacarpentry.org/r-raster-vector-geospatial/10-vector-csv-to-shapefile-in-r/) [dataset  datum](https://vents-data.interridge.org/sites/vents-data.interridge.org/files/InterRidge_Vents_Database_Version3.1_documentation.pdf)
+ Seamounts: 30% (but some advocate for more: Letessier et al., 2019, PLOS Biology)
+ Plateaus: 30%


```{r Deep-sea features, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}
Seamounts <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/BlueHabs/Seamounts.shp"
PUxSeamounts <- fSpatPlan_Get_Polyg(Seamounts, PUs)  
PUs <- PUs %>% 
  mutate(Seamounts = PUxSeamounts)

Plateaus <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/BlueHabs/Plateaus.shp"
PUxPlateaus <- fSpatPlan_Get_Polyg(Plateaus, PUs)  
PUs <- PUs %>% 
  mutate(Plateaus = PUxPlateaus)

Vents <- read.csv("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/vents.csv")
VentsActive <- filter(Vents, Activity == "active, confirmed" | Activity == "active, inferred") 
VentsActiveSF <- st_as_sf(VentsActive, coords = c(x = "Longitude", y = "Latitude"), crs = 4326) %>% 
  st_transform(cCRS)

PUxVentsActive <- st_contains(PUs,VentsActiveSF, sparse = FALSE) %>%
  rowSums() %>% 
  as.logical()
PUs <- PUs %>% 
  mutate(Active_Vents = PUxVentsActive)

VentsInactive <- filter(Vents, Activity == "inactive")
VentsInactiveSF <- st_as_sf(VentsInactive, coords = c(x = "Longitude", y = "Latitude"), crs = 4326) %>% 
  st_transform(cCRS)

PUxVentsInactive <- st_contains(PUs,VentsInactiveSF, sparse = FALSE) %>%
  rowSums() %>% 
  as.logical()
PUs <- PUs %>% 
  mutate(Inactive_Vents = PUxVentsInactive)

```

```{r vents plot, echo = FALSE, message = FALSE, warning = FALSE, results = "hide"}
world <- ne_countries(scale = "medium", returnclass = "sf")
#IndianO <- c(xmin = 17.47941, ymin = -38.7402, xmax = 129.552, ymax = 33.82872)
IndianO <- c(xmin = 20, xmax = 120, ymin = -60, ymax = 20)

#ggplot() + 
 # geom_sf(data = world) + 
  #geom_sf(data = VentsInactiveSF) +
  #ggtitle("Active vents after st_tranform(cCRS)") +
  #coord_sf(xlim = c(IndianO[["xmin"]], IndianO[["xmax"]]), ylim = c(IndianO[["ymin"]], IndianO[["ymax"]]), expand = FALSE) 

# no longer needed
#PUxVents <- st_join(PUs, VentsActiveSF, join = st_within) 
#VentsActiveSFClean <- dplyr::select(VentsActiveSF, Name.ID, geometry)
#VentsActiveSFCleanBuff <- st_buffer(VentsActiveSFClean, dist = 1000)
#PUxVents <- st_intersects(VentsActiveSF, PUs)
#PUs <- PUs %>% 
#  mutate(Vents = PUxVents)
  
```


```{r Conservation features, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}

IMMA <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/IMMAs/iucn-imma.shp")
IBA <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/IBAs/MarineIBA_IndianOcean.shp")
NEIO_09<- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/NEIO_9_EBSA/NEIO_9_EBSA.shp")
NWIO_14 <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/NWIO_14_EBSA/NWIO_14_EBSA.shp")
SIO_11 <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_11_EBSA-GIS shapefile/SIO_11_EBSA.shp")
SIO_19 <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_19_EBSA-GIS%20shapefile/SIO_19_EBSA.shp")
SIO_22 <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_22_EBSA-GIS shapefile/SIO_22_EBSA.shp")
SIO_23 <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_23_EBSA-GIS shapefile/SIO_23_EBSA.shp")
SIO_30 <- st_read  ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_30_EBSA-GIS shapefile/SIO_30_EBSA.shp")
SIO_32 <- st_read  ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_32/SIO_32_EBSA.shp")
SIO_35<- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_35_EBSA-GIS shapefile/SIO_35_EBSA.shp")
SIO_36 <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_36_EBSA-GIS shapefile/SIO_36_EBSA.shp")
SIO_37  <-st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_37_EBSA-GIS shapefile/SIO_37_EBSA.shp")
Seamounts <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/BlueHabs/Seamounts.shp")
Plateaus <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/BlueHabs/Plateaus.shp")
```

Conservation features

```{r Conservation features plot, echo = FALSE, message = FALSE, warning = FALSE}

IndianO <- c(xmin = 20, xmax = 120, ymin = -60, ymax = 20)

ggplot() + 
  geom_sf(data = world) +
  geom_sf(data = NEIO_09,  aes(color="A"), show.legend = "line")+ 
  geom_sf(data = NWIO_14,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_11,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_19,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_22,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_23,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_30,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_32,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_35,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_36, aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_37,  aes(color="A"), show.legend = "line")+
  geom_sf(data = Seamounts,  aes(color="B"), show.legend = "line")+
  geom_sf(data = Plateaus,  aes(color="C"), show.legend = "line")+
  geom_sf(data = IBA,  aes(color="D"), show.legend = "line") + 
  geom_sf(data = IMMA,  aes(color="E"), show.legend = "line")+ 
  geom_sf(data = VentsActiveSF,  aes(color="F"), show.legend = "line")+
  geom_sf(data = VentsInactiveSF,  aes(color="G"), show.legend = "line")+
  ggtitle("IBA, IMMA, EBSAs, Seamounts, Plateaus, Vents")+ 
  coord_sf(xlim = c(18, 130), ylim = c(22, -60), expand = FALSE)+
  scale_color_manual(values = c("A" = "grey", "B" = "black", "C" = "blue", "D" = "green", "E" = "purple", "F" = "red", "G" = "brown"), 
                     labels = c("EBSAs", "Seamounts", "Plateaus", "IBAs", "IMMAs", "Active vents", "Inactive Vents"),
                     name = "Legend") 

```

### Longhurst provinces

```{r longhurst plot, echo = FALSE, message = FALSE, warning = FALSE}

longh <- st_read(file.path("Data","LonghurstProvinces","Longhurst_world_v4_2010.shp")) %>% 
  st_make_valid()
longhRob <- st_transform(longh, cCRS)

nr <- st_nearest_feature(PUs, longhRob)

PUs <- PUs %>% 
  mutate(ProvCode = longh$ProvCode[nr],
         ProvDescr = longh$ProvDescr[nr])

ggplot() + 
  geom_sf(data = world, color = "grey20", fill = "grey20", size = 0.1, show.legend = FALSE) +
  geom_sf(data = PUs, aes(fill = ProvCode), colour = "grey50", size = 0.05, alpha = 0.7, show.legend = TRUE) +
  coord_sf(xlim = c(18, 130), ylim = c(22, -60), expand = FALSE)
           
```

### Targets dataframe

```

#Cons_feats <- tibble(Features = c("IBA", "IMMA", "NEIO_09", "NWIO_14", "SIO_11", "SIO_19", "SIO_22", "SIO_23", "SIO_30", "SIO_32", "SIO_35", "SIO_36", "SIO_37","Seamounts", "Plateaus", "Active_Vents", "Inactive_Vents"), Targets = c(0.3, 0.3, 0.3, 0.3, 0.3, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.3, 0.3, 0.7, 0.7))

```

## Locked out areas

### polymetallic nodules / polymetallic sulfides: exploration & reserved areas

```{r Locked out, echo = FALSE, message = FALSE, warning = FALSE, results = "hide"}

ExplPMN <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/01_pmn_exploration_areas.shp"
PUxExplPMN <- fSpatPlan_Get_Polyg(ExplPMN, PUs)  
PUs <- PUs %>% 
  mutate(ExplPMN = PUxExplPMN)

ExplPMS <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/02_pms_exploration_areas.shp"
PUxExplPMS <- fSpatPlan_Get_Polyg(ExplPMS, PUs)  
PUs <- PUs %>% 
  mutate(ExplPMS = PUxExplPMS)

ResPMN <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/04_pmn_reserved_areas.shp"
PUxResPMN <- fSpatPlan_Get_Polyg(ResPMN, PUs)  
PUs <- PUs %>% 
  mutate(ResPMN = PUxResPMN)

``` 


```{r Plotting Locked out, echo = FALSE, message = FALSE, warning = FALSE}
# plotting locked out areas

world <- ne_countries(scale = "medium", returnclass = "sf")
IndianO <- c(xmin = 18, ymin = -60, xmax = 130, ymax = 22)
Expl_PMN <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/01_pmn_exploration_areas.shp")
Expl_PMS <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/02_pms_exploration_areas.shp")
Res_PMN <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/04_pmn_reserved_areas.shp")

ggplot() + 
  geom_sf(data = world) +
  geom_sf(data = Expl_PMN, aes(color="A"), show.legend = "line") + 
  geom_sf(data = Expl_PMS, aes(color="B"), show.legend = "line") +
  geom_sf(data = Res_PMN, aes(color="C"), show.legend = "line") +
  scale_color_manual(values = c("A" = "red", "B" = "yellow", "C" = "black"),
                     labels = c("Expl_PMN", "Expl_PMS", "Res_PMN"),
                     name = "Legend") +
  ggtitle("Exploration & Reserved areas") + 
  coord_sf(xlim = c(18, 130), ylim = c(22, -60), expand = FALSE)

```

## Cost layer

Composed of 

+ PMN and CFC areas (Sharma, 2011/ Mizell et al., 2022 for USD valuation) - in progress
+ Fishing effort (using ready-made cost layer in Spatial Planning repo)
+ Shipping routes (use value of cell in Halpern et al. (2015), 2013 dataset for relative cost) - in progress, but should be used as penalty, not cost?

Need to define how to combine these costs into 1 layer. Mult-C Sync software (Moffett et al., 2005  / Cameron et al., 2008)? 

Or: running multiple prioritization problems and defining **no-regret** MPAs across stakeholders. 

### Mineral resources

```{r Plot PMN CFC, echo = FALSE, message = FALSE, warning = FALSE}
#' Plotting mining resources

world <- ne_countries(scale = "medium", returnclass = "sf")
#IndianO <- c(xmin = 17.47941, ymin = -38.7402, xmax = 129.552, ymax = 33.82872)
IndianO <- c(xmin = 20, xmax = 120, ymin = -60, ymax = 20)
CFC <- st_read("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_resources/Crust/Crust_areas_Hein2013.shp")
PMN <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_resources/Nodules/Nodules_Hein2013.shp")
ggplot() + 
  geom_sf(data = world) +
  geom_sf(data = CFC, aes(color="A"), show.legend = "line") + 
  geom_sf(data = PMN, aes(color="B"), show.legend = "line") + 
  scale_color_manual(values = c("A" = "grey", "B" = "brown"),
                     labels = c("CFC", "PMN"),
                     name = "Legend") +
  ggtitle("Polymetallic Nodules and Cobalt-rich Ferromanganese Crust areas") + 
  coord_sf(xlim = c(18, 130), ylim = c(22, -60), expand = FALSE)

```

CFC value
script to get area modified from https://rpubs.com/rural_gis/255550

```{r CFC, echo = FALSE, message = FALSE, warning = FALSE, results = "hide"}
CFC <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_resources/Crust/Crust_areas_Hein2013.shp" 
PUxCFC <- fSpatPlan_Get_Polyg(CFC, PUs)  # function returns out as a logical vector
PUs <- PUs %>% 
  mutate(CFC = PUxCFC)

#load CFC areas polygon shapefile 
CFC <- st_read("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_resources/Crust/Crust_areas_Hein2013.shp")
CFCRobin <- st_transform(CFC, cCRS) #robin proj

#run the intersect function, converting the output to a tibble in the process
#int <- as_tibble(st_intersection(CFCRobin, BndryABNJ))
int <- st_intersection(CFCRobin, BndryABNJ)

#add in an area count column to the tibble (area of each CFC poly in intersect layer)
int$CFCarea <- st_area(int)
```

Intersections between PUs and CFC in red - correct

```{r plot CFC, echo = FALSE, message = FALSE, warning = FALSE}

#plot the layers to visually check result of intersect
plot (CFCRobin$geometry, col='green')
plot(BndryABNJ$geometry, add=T)
plot(int, col='red', add=T) #correct

#group data by county area and calculate the total arable land area per county
#output as new tibble
AreaCFCtotal <- int %>%
  summarise(areaCFCtot = sum(CFCarea))
```

```
# CFC value code (so you can have a look)
# script to get area modified from https://rpubs.com/rural_gis/255550

CFC <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_resources/Crust/Crust_areas_Hein2013.shp" 
PUxCFC <- fSpatPlan_Get_Polyg(CFC, PUs)  # function returns out as a logical vector
PUs <- PUs %>% 
  mutate(CFC = PUxCFC)

#load CFC areas polygon shapefile 
CFC <- st_read("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_resources/Crust/Crust_areas_Hein2013.shp")
CFCRobin <- st_transform(CFC, cCRS) #robin proj

#run the intersect function, converting the output to a tibble in the process
#int <- as_tibble(st_intersection(CFCRobin, BndryABNJ))
int <- st_intersection(CFCRobin, BndryABNJ)

#add in an area count column to the tibble (area of each CFC poly in intersect layer)
int$CFCarea <- st_area(int)

#plot the layers to visually check result of intersect
plot (CFCRobin$geometry, col='green')
plot(BndryABNJ$geometry, add=T)
plot(int, col='red', add=T) #correct

#group data by county area and calculate the total arable land area per county
#output as new tibble
AreaCFCtotal <- int %>%
  summarise(areaCFCtot = sum(CFCarea)) # = 2.256596e+12 [m^2]
```
**CFC area = 2.256596e+12 [m^2], seems a lot (see code above, no error messages but probably wrong somewhere)? Would be 2256596 sqkm, and I have 39803 PUs of 1000 sqkm each** 

*Other method to check :* 
area of CFC in PUs < 2753*1000 sqkm = 2.753e+6 sqm (see sum of TRUE intersections between PUs and CFC poly below)

```
sum(PUxCFC) # sum of cross = TRUE between PUs and CFC polyg
[1] 2753

```
PMN - same code

```{r PMN, echo = FALSE, message = FALSE, warning = FALSE, results = "hide"}

# PMN value

#script to get area modified from https://rpubs.com/rural_gis/255550

#load county areas polygon shapefile 

PMN <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_resources/Nodules/Nodules_Hein2013.shp"
PUxPMN <- fSpatPlan_Get_Polyg(PMN, PUs)  
PUs <- PUs %>% 
  mutate(PMN = PUxPMN)

PMN <- st_read("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_resources/Nodules/Nodules_Hein2013.shp")
PMNRobin <- st_transform(PMN, cCRS) #robin proj

#run the intersect function, converting the output to a tibble in the process
int2 <- st_intersection(PMNRobin, BndryABNJ) #need this to avoid Error in UseMethod("st_area") : 
#int2 <- as_tibble(st_intersection(PMNRobin, BndryABNJ)) #no applicable method for 'st_area' applied to an object of class "c('tbl_df', 'tbl', 'data.frame')"

#add in an area count column to the tibble (area of each CFC poly in intersect layer)
int2$PMNarea <- st_area(int2)
```

Intersection between PUs and PMN in red - correct

```{r plot PMN, echo = FALSE, message = FALSE, warning = FALSE}

#plot the layers to visually check result of intersect
plot (PMNRobin$geometry, col='green')
plot(BndryABNJ$geometry, add=T)
plot(int2, col='red', add=T) #correct

#group data by county area and calculate the total arable land area per county
#output as new tibble
AreaPMNtotal <- int2 %>%
  summarise(areaPMNtot = sum(PMNarea)) #1.933646e+12 [m^2],  seems a lot?
```

**Same issue for PMN as for CFC: intersection area too high: gives 1.933646e+12 [m^2],  seems a lot?**

*other method to check*
area of PMN in PUs < 2075*1000 sqkm = 2.075e+6 sqm (see sum of TRUE intersections between PUs and CFC poly below)

```
# area of PMN in PUs should be < 2075*1000 sqkm because:
 sum(PUxPMN)
 [1] 2075
# and 1 PU = 1000 sqkm
### Fishing cost

```{r Fishing cost, echo = FALSE, message = FALSE, warning = FALSE}
 
#Fishing cost

FishingCost <- terra::rast("Data/Cost/Cost_Raster_Sum.grd") %>% 
  terra::as.polygons(trunc = FALSE, dissolve = FALSE, na.rm=FALSE) %>% # Convert to polygon data
  st_as_sf() %>% # Convert to sf
  st_transform(cCRS) %>% # transform to robinson
  st_interpolate_aw(PUs, extensive = FALSE) %>% ## intersect with PUs
  rename(FishingCost = layer)

PUs <- PUs %>% 
  mutate(Fishing = FishingCost$FishingCost)

LogFishing <- log10(FishingCost$FishingCost)
hist(LogFishing)
PUs <- PUs %>% 
  mutate(LogFishing = LogFishing)

#' Plotting log of fishing cost

ggplot() + 
  geom_sf(data = world) +
  geom_sf(data = PUs, aes(color=LogFishing)) + 
  ggtitle("Fishing Cost (Log10)") + 
  coord_sf(xlim = c(18, 130), ylim = c(22, -60), expand = FALSE)

#(ggCost <- fSpatPlan_PlotCost(Cost, world)) # Plot cost

#FishingCost <- fSpatPlan_Get_Cost(PUs, cCRS) ##make sure cost function is set to fetch .grd in proper directory ##cannot open .grd despite changing pathway in fx

```


```

## Shipping

Overlay shipping raster with polygons to get average intensity of shipping for 1 PU. **Check code, no errors but many issues.**

```

Shipping <- terra::rast("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Shipping/shipping.tif")
#View(Shipping)
#plot(Shipping, main = 'Shipping routes')
ShippingRobin <- terra::project(Shipping, "ESRI:54030") #transform to robin proj
#plot(ShippingRobin, main = 'Shipping routes')
PUxShipping <- exactextractr::exact_extract(ShippingRobin, PUs, "mean") # attribute mean value of pixels in each PU to PU
PUs <- PUs %>% 
  mutate(ShippingIntensity = PUxShipping) # add column to PU data frame

#ShippingPlusOne <- Shipping$shipping +1
#ShippingLog <- log10(ShippingPlusOne)
#hist(log10(ShippingPlusOne))  #Warning: [hist] a sample of0% of the cells was used (of which 21% was NA); meaning +1 didn't work?

#ShippingRobin <- terra::project(Shipping, "cCRS") #Error: [project] cannot get output boundaries

#ShippingRobin <- project(Shipping, "+proj=robin +lon_0=0 +x_0=0 +y_0=0 #+datum=WGS84 +units=m +no_defs") # no error but does not assign projection

#ShippingRobin <- project(Shipping, "ESRI:54030", method = "near") #transform to robin proj # error about method "near"

```


```
# not using this method because file to heavy to use as.polygons

ShippingCost <- terra::rast("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Shipping/shipping.tif") %>% 
    terra::as.polygons(trunc = FALSE, dissolve = FALSE, na.rm=FALSE) %>% # Convert to polygon data
    st_as_sf() %>% # Convert to sf
    st_transform(cCRS) %>% # Transform to projection
    st_interpolate_aw(PUs, extensive = FALSE) %>% ## intersect with PUs
    rename(ShippingCost = layer)
```

# Prioritizr problems

Trial runs
```{r Prioritizr problems, echo = FALSE, message = FALSE, warning = FALSE}

PUs$Fishing[PUs$Fishing <  0.0001] <-  0.0001 #to avoid Warning in presolve_check.OptimizationProblem(compile(x)) :
# planning units with very high (> 1e+6) or very low (< 1e-6) non-zero cost values note this may be a false positive

#' IBA & Fishing cost

p_IBA_Fishing <- problem(PUs, features = "IBA", cost_column = "Fishing") %>% 
  add_min_set_objective() %>%
  add_relative_targets(0.9) %>%
  add_binary_decisions() %>%
  add_gurobi_solver(gap = 0.1, verbose = FALSE) 

p_IBA_Fishing_Sol <- solve(p_IBA_Fishing)

p_IBA_Fishing_Sol_Plot <- ggplot() +
  ggtitle("IBA vs Fishing, Target = 0.9") +
  geom_sf(data = world, colour ="grey70") +
  geom_sf(data = p_IBA_Fishing_Sol, aes(fill = as.factor(solution_1)), size = 0.05) +
  scale_fill_manual(values = c("NA", "red")) +
  coord_sf(xlim = c(18, 130), ylim = c(22, -60), expand = FALSE) +
  theme_bw() +
  #scale_colour_gradientn(colours = colorspace::diverge_hcl(7)) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank())

p_IBA_Fishing_Sol_Plot #looks correct 

#' Active Vents & Fishing cost & target

p_Active_Vents_Fishing <- problem(PUs, features = "Active_Vents", cost_column = "Fishing") %>% 
add_min_set_objective() %>%
  add_relative_targets(0.7) %>%
  add_binary_decisions() %>%
  add_gurobi_solver(gap = 0.1, verbose = FALSE)

p_Active_Vents_Fishing_Sol <- solve(p_Active_Vents_Fishing)

p_Active_Vents_Fishing_Sol_Plot <- ggplot() +
  ggtitle("Active Vents vs Fishing, Targets = 0.7") +
  geom_sf(data = world, colour ="grey80") +
  geom_sf(data = p_Active_Vents_Fishing_Sol, aes(fill = as.factor(solution_1)), size = 0.05) +
  scale_fill_manual(values = c("NA", "red")) +
  coord_sf(xlim = c(18, 130), ylim = c(22, -60), expand = FALSE) +
  theme_bw() +
  #scale_colour_gradientn(colours = colorspace::diverge_hcl(7)) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank())

p_Active_Vents_Fishing_Sol_Plot # also looks correct
```

Full run 

```{r Prioritizr problems2, echo = FALSE, message = FALSE, warning = FALSE}
#' All features & Fishing cost & targets

p_ConsFeat_Fishing <- problem(PUs, features = c("IBA", "IMMA", "NEIO_09", "NWIO_14", "SIO_11", "SIO_19", "SIO_22", "SIO_23", "SIO_30", "SIO_32", "SIO_35", "SIO_36", "SIO_37","Seamounts", "Plateaus", "Active_Vents", "Inactive_Vents"), cost_column = "Fishing") %>% 
  add_min_set_objective() %>%
  add_relative_targets(c(0.3, 0.3, 0.3, 0.3, 0.3, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.3, 0.3, 0.7, 0.7)) %>%
  add_binary_decisions() %>%
  add_gurobi_solver(gap = 0.1, verbose = FALSE)

p_ConsFeat_Fishing_Sol <- solve(p_ConsFeat_Fishing)
#plot(p_ConsFeat_Fishing_Sol, main = "solution")
#lines(p_ConsFeat_Fishing_Sol[p_ConsFeat_Fishing_Sol$solution_1 > 0.5, ], col = "darkgreen", lwd = 2)

p_ConsFeat_Fishing_Sol_Plot <- ggplot() +
  ggtitle("Cons Feats vs Fishing, 0.3<Targets<0.7") +
  geom_sf(data = world, colour ="grey80") +
  geom_sf(data = p_ConsFeat_Fishing_Sol, aes(fill = as.factor(solution_1)), size = 0.05) +
  scale_fill_manual(values = c("NA", "red")) +
  coord_sf(xlim = c(18, 130), ylim = c(22, -60), expand = FALSE) +
  theme_bw() +
  #scale_colour_gradientn(colours = colorspace::diverge_hcl(7)) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank())

p_ConsFeat_Fishing_Sol_Plot # shows that fishing cost is reduced between 40°-60°S, but maybe would be good to reduce target for IBAs/IMMAs or assign Longhurst to distribute better across latitudes


```

Run with lock out: no errors in  .R but won't knit

```

#' All features & Fishing cost & targets & locked-out exploration + reserved areas

PUs["locked_out"] = PUs$ExplPMN | PUs$ExplPMS | PUs$ResPMN # create locked_out column (logical). If =<1 is TRUE, then locked_out is TRUE # https://stackoverflow.com/questions/54507486/merging-two-true-false-dataframe-columns-keeping-only-true

#PUs["locked_out"] <- paste(PUs$ExplPMN, PUs$ExplPMS, PUs$ResPMN)
#PUs %>% mutate(sum = rowSums(across(where(is.logical))))rowSums(Y) > 0
#PUs$LockedOut <- ifelse(PUs$ExplPMN == "TRUE" | PUs$ExplPMS == "TRUE" | PUs$ResPMN == "TRUE")
 
p_ConsFeat_Fishing_LockedOut <- problem(PUs, features = c("IBA", "IMMA", "NEIO_09", "NWIO_14", "SIO_11", "SIO_19", "SIO_22", "SIO_23", "SIO_30", "SIO_32", "SIO_35", "SIO_36", "SIO_37","Seamounts", "Plateaus", "Active_Vents", "Inactive_Vents"), cost_column = "Fishing") %>% 
  add_min_set_objective() %>%
  add_relative_targets(c(0.3, 0.3, 0.3, 0.3, 0.3, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.3, 0.3, 0.7, 0.7)) %>%
  add_binary_decisions() %>%
  add_locked_out_constraints(locked_out = "locked_out") %>%
  add_gurobi_solver(gap = 0.1, verbose = FALSE)

p_ConsFeat_Fishing_LockedOut_Sol <- solve(p_ConsFeat_Fishing_LockedOut)

p_ConsFeat_Fishing_LockedOut_Sol_Plot <- ggplot() +
  ggtitle("Cons Feats vs Fishing, Mining Contractors Locked Out, 0.3<Targets<0.7") +
  geom_sf(data = world, colour ="grey80") +
  geom_sf(data = p_ConsFeat_Fishing_Sol, aes(fill = as.factor(solution_1)), size = 0.05) +
  scale_fill_manual(values = c("NA", "red")) +
  coord_sf(xlim = c(18, 130), ylim = c(22, -60), expand = FALSE) +
  theme_bw() +
  #scale_colour_gradientn(colours = colorspace::diverge_hcl(7)) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank())

p_ConsFeat_Fishing_LockedOut_Sol_Plot
```

```

#' All features & Fishing cost & targets & locked-out exploration + reserved areas, change targets to check solver works

length(PUs$Plateaus[PUs$Plateaus==TRUE]) # check count of PUs that have plateaus inside

p_check_targets <- problem(PUs, features = c("IBA", "IMMA", "NEIO_09", "NWIO_14", "SIO_11", "SIO_19", "SIO_22", "SIO_23", "SIO_30", "SIO_32", "SIO_35", "SIO_36", "SIO_37","Seamounts", "Plateaus", "Active_Vents", "Inactive_Vents"), cost_column = "Fishing") %>% 
add_min_set_objective() %>%
  add_relative_targets(c(0.001, 0.001, 0.03, 0.03, 0.03, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.99, 0.99, 0.99, 0.99)) %>%
  add_binary_decisions() %>%
  add_locked_out_constraints(locked_out = "locked_out") %>%
  add_gurobi_solver(gap = 0.1, verbose = FALSE)

p_check_targets_sol <- solve(p_check_targets)

p_check_targets_sol_plot <- ggplot() +
  ggtitle("0.001<Targets<0.9") +
  geom_sf(data = world, colour ="grey80") +
  geom_sf(data = p_ConsFeat_Fishing_Sol, aes(fill = as.factor(solution_1)), size = 0.05) +
  scale_fill_manual(values = c("NA", "red")) +
  coord_sf(xlim = c(18, 130), ylim = c(22, -60), expand = FALSE) +
  theme_bw() +
  #scale_colour_gradientn(colours = colorspace::diverge_hcl(7)) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank())

p_check_targets_sol_plot #correct

``` 

# Discussion

## Potential improvements

# Conclusion