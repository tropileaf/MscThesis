---
title: "Cross-sectoral conservation of the Indian Ocean"
author: "Lea Fourchault"
date: "22/02/2022"
output: html_document
---
<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 34px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 24px;
  color: Black;
}
h2 { /* Header 2 */
    font-size: 20px;
  color: Black;
}
h3 { /* Header 3 */
  font-size: 14px;
  color: Black;
}
code.r{ /* Code block */
    font-size: 11px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---

# Table of Contents
# Introduction
# Materials & Methods
## Workflow with Prioritizr 
## Overview of data  & layers
## Planning region 
## Conservation features & targets
### IBAs
### IMMAs
### EBSAs
### Deep-sea features : seamounts, ridges, plateaus, vents 
### Targets dataframe
## Cost layer
### CFC
### PMN
### Exploration areas
### Reserved areas
### Shipping
### Fishing *use cost layer already created?*
# Prioritizr problems
### Basic run (only Cons features)
### Cons features, fishing
### Cons features, mining (lock-out expl  & res areas; assign cost for PMN areas)
### Cons features, fishing + mining 
### Cons features, shipping 
# Discussion
## Potential improvements
# Conclusion

---

Resolved questions:

+ how to group all files (ex: all EBSAs + IBAs + IMMAs + vents + seamounts...) into one, to create ConsFeatures? Or is it enough to have columns next to PUs? RESOLVED: yes, stacking = creating columns next to PUs.
+ should we use Sharma (2011) + CRU Consulting (2019) to assign USD values to PMN areas? see PMN subsection. RESOLVED, yes, can use for this project (need to cross-check if want to publish)
+ shipping raster : cells have certain values (# of ships recorded?? I can't figure from the attached files, metadata is confusing), could allow to infer USD value of route (# of ships * approx cost of fuel for average cargo to go through 1 PU, which is 1000sqkm)? So we wouldn't try to compute the cost of deviating from any given route, but rather compute the price for each ship to go through 1 PU * the number of ships going through that PU. It sounds fairly logical to me, but maybe it's not? RESOLVED: check 2008 metada, run prio problem with only shipping
+ fishing cost layer : there is a ready-made fx in SpatPlan repo (thanks Jase & Tin), should we use it for this project? see fishing subsection (but issues with plotting  as you can see). RESOLVED: yes, use fx from Jase & Tin. Change scale to remove outliers/crop to planning region.
+ I'm using echo = FALSE, message = FALSE, warning = FALSE, results = "hide" and still can't get rid of some coding output in the .html. RESOLVED: cut up chuncks of code with separate ones for plots
+ I st_to_sf the vents from .csv with PUs' crs but have some issues intersecting the points with polygs, will look more into it. RESOLVED: use st_contains after crs = 4326 & st_transform(cCRS)
+ add list of species as cons_feats: EN, VU etc (Ant's email to mining colleague)? RESOLVED: fine-tune later
+ shipping raster (Halpern et al., 2013) is too heavy to be converted to polygon, what could be other methods (not using as.polygon)? RESAMPLE if resolution <1°. Resolution = 934m*934m (! 1° at equator = 111km = 60 nm; [convert](https://www.johndcook.com/how_big_is_a_degree.html); resolution too fine so need resampling). RESOLVED: no resampling, overlay raster with PUs (exactextractr) to attribute mean raster cells value to PUs (no weighted mean because raster cells are all equal-area because Mollweide proj)
+ how to remove EEZs from PUs? RESOLVED: find EEZ shp and spatial predicates, inverse overlay with Bndry, recreate PUs
+ setting  targets. RESOLVED: 30% for rpz area, 70% for important/rare feature; create dataframe with 1 column: features, 1 column: targets (match order)

---

Current questions & issues:

+ ongoing - pricing deep-sea mineral resources (I am looking for more papers especially regarding CFC)
+ check research questions
+ overlay shipping & PUs + plot with log10?
+ cross inactive vents & PUs - done
+ how to assign price to mining shps
+ assigning targets - write chunk

--- 

Parameters we agree on for first prioritizr run

+ PUs = ABNJ only
+ cons feats = IMMAs, IBAs, chosen EBSAs, vents (active + inactive), seamounts, plateaus; no aquamaps
+ mining cost = value/t * density * area, discount rate and other improvements to be determined later (if any), USD
+ fishing cost = removed fish mass * fish value (layer created by Jase), USD
+ shipping cost = mean of shipping raster cells' values for each PU, not USD (intensity)
+ targets = 30% for rpz area, 70% for important

---


# Introduction

*This project aims to identify areas for MPAs that maximise the conservation of biologically and ecologically important areas in the Indian Ocean's ABNJS, across all depths, while minimizing conflict with local industrial stakeholders - including the fishing, shipping, and deep-sea mining industries.*

**Possible research questions**

Ranked from most general to most precise, can be same question with different wording (some are in passive form, I know it's better to use active but some sound weird when saying 'we'?)

1. how can marine spatial planning adapt to a time of increased anthropogenic pressures?
2. how can the interests of multiple industrial stakeholders be incorporated into MPA design?
3. how can value be estimated in the context of data-poor industries?
4. which areas are most valuable to industrial stakeholders in the Indian Ocean?
5. how can we design MPAs that minimize trade-offs with industrial stakeholders in the Indian Ocean?
6. how can we design MPAs that maximize biodiversity conservation across depth layers in the Indian Ocean?
7. how can we quantify/estimate trade-offs amongst industries in the Indian Ocean?
8. how can we quantify/estimate trade-offs between industries and conservation in the Indian Ocean? and,
9. how can such trade-offs with industrial stakeholders be minimized when designing MPAs?

Why ABNJs?

+ to reach the global target of 30% marine protection, ABNJs are optimal (largest area; common good: higher incentive to protect since lower opportunity cost for individual countries)
+ but maybe we can also include non ABNJ? (because shipping data more interesting in EEZs, tbd later)

Why the Indian Ocean?

+ numerous ecosystems providing important services and unique biodiversity, but few already existing MPAs within EEZs and none in ABNJs
+ active exploration of PMN & CFC for deep sea mining but no plan for conservation linked to deep-sea mining (unlike Pacific)
+ many stakeholders present (increasingly dense shipping routes, fishing activity, deep-sea mining): higher risk of conflict: prioritization approach should be useful

Why considering all depth layers? 

+ despite unique biodiversity, the deep sea is often ignored in MPA design
+ the deep sea increasingly at risk from anthropogenic disturbances
+ we need to consider all layers to ensure vertical connectivity
+ the implementation of MPAs is only feasible on surface level (makes no sense to focus only on deep-sea, even if major preoccupation is benthic or at high depth).

Why considering multiple stakeholders?

+ so far, most MPA design is based on the fishing industry alone (despite some rather unsuccessful attempts to include tourism or other industries)
+ deep-sea mining has not yet been considered in MPA design by prioritization, despite major foreseen impacts on marine biodiversity
+ shipping routes (cargo, tankers, tourism) also disturb marine fauna, especially charismatic megafauna

```{r, echo = FALSE, results = "hide", message = FALSE}
#Open all the packages and get extras
options(repos = list(CRAN="http://cran.rstudio.com/")) 
library(tidyverse)
library(sf)
library(patchwork)
library(terra)
library(stars)
library(rnaturalearth)
library(rnaturalearthdata)
library(prioritizr)
library(knitr)

source("SpatPlan_Extras.R")

fSpatPlan_Get_Polyg <- function(filen, PUs){
  
  polyg_crs <- st_crs(PUs)
  Polyg1 <- st_read(filen) %>% 
    st_transform(polyg_crs) 
  
  Polyg1PUs <- PUs %>% 
    st_centroid() %>% #Second, get all the PUs with < 50 % area on land #?
    st_within(Polyg1, sparse = FALSE) %>% 
    rowSums() %>%
    as.logical()
  
  # Polyg1PUs <- PUs %>% 
  #   mutate(locked_in = Polyg1PUs) ##assign new column to PUs (call it name of shp)
  # 
  return(Polyg1PUs)
}
```

# Materials and Methods

## Prioritizr workflow

Inputs needed:

+ planning region & PUs
+ conservation features & conservation targets
+ cost layer

## Layers overview

blue habitats **do not include hydro vents**, so will use Beaulieu & Szanfranski (2020) [link](https://doi.pangaea.de/10.1594/PANGAEA.917894?format=html#download)


Input type   |  Topic                 | Reference/source (format)
:-----------:|:----------------------:|:----------------------------------:
 COST        |  Expl + Res (mining)   |  ISA (shp)
 COST        |  PMN & CFC (mining)    |  Petersen et al., 2016 (shp)
 COST        |  Shipping              |  Halpern et al., 2015 (tif from 2013)
 COST        |  Fishing               |  Cost layer created by Jase
 CONS        |  IBAs                  |  Birdlife datazone (shp)
 CONS        |  IMMAs                 |  importantmarinemammalhabitat (shp)
 CONS        |  EBSAs                 |  CBD (shp)
 CONS        |  Benthic features      |  Blue Habitats (shp)
 CONS        |  Longhurst provinces ? |  Marine Regions (shp)
 CONS        |  Active vents          |  Beaulieu & Szanfranski (2020) (csv)
 CONS        |  Inactive vents        |  Beaulieu & Szanfranski (2020) (csv)
 
## Planning region 

*substract EEZs shp from boundary, then recreate PUs*

```{r Planning Region, echo = TRUE, message = FALSE, results = "hide", warning = FALSE}

cCRS <- "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs" # Robinson projection
world <- ne_countries(scale = "medium", returnclass = "sf") %>% 
  st_transform(cCRS)
Region <- c(xmin = 18, xmax = 130, ymin = -39, ymax = 34) # Indian Ocean limits
Bndry <- fSpatPlan_Get_Boundary(Region, cCRS) # boundary

PU_size <- 1000 # in km2, but check resolution for this project?
Shape <- "Hexagon" # shape of PUs
MinDepth <- 0
MaxDepth <- 200 # but check for deep-sea?
PUs <- fSpatPlan_Get_PlanningUnits(Bndry, world, PU_size, Shape)

```

Planning Units
```{r PUs, echo=FALSE}
(ggPU <- fSpatPlan_PlotPUs(PUs, world)) # Plot Planning Units
```

## Conservation features & targets

Composed of 

+ Important Bird Areas
+ Important Marine Mammal Areas
+ EBSAs
+ Deepsea features: active + inactive vents, seamounts, plateaus

### Important Bird Areas

Conservation targets = 30%

```{r IBAs, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}

#loading file 
IBA <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/IBAs/MarineIBA_IndianOcean.shp"

#crossing shp & PUs
PUxIBA <- fSpatPlan_Get_Polyg(IBA, PUs)  
PUs <- PUs %>% 
  mutate(IBA = PUxIBA) #add column to PU table with
```

### Important Marine Mammal Areas

Conservation targets = 30%

```{r IMMAs, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}

#loading file
IMMA <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/IMMAs/iucn-imma.shp"

#crossing shp & PUs
PUxIMMA <- fSpatPlan_Get_Polyg(IMMA, PUs)  
PUs <- PUs %>% 
  mutate(IMMA = PUxIMMA)
```

### Ecologically and Biologically Significant Areas

Chosen to be:

+ within ABNJs (at least partially)
+ not redundant with IMMAs or IBAs

Targets: *need to write chunck*

+ NEIO_09 : 30%
+ NWIO_14 : 30%
+ SIO_11 :  30%
+ SIO_19 :  70%
+ SIO_22 :  70%
+ SIO_23 :  70%
+ SIO_30 :  70%
+ SIO_32 :  70%
+ SIO_35 :  70%
+ SIO_36 :  70%
+ SIO_37 :  70%

```{r EBSAs, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}

NEIO_09<- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/NEIO_9_EBSA/NEIO_9_EBSA.shp"
PUxNEIO_09 <- fSpatPlan_Get_Polyg(NEIO_09, PUs)  
PUs <- PUs %>% 
  mutate(NEIO_09 = PUxNEIO_09)

NWIO_14 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/NWIO_14_EBSA/NWIO_14_EBSA.shp"
PUxNWIO_14 <- fSpatPlan_Get_Polyg(NWIO_14, PUs)  
PUs <- PUs %>% 
  mutate(NWIO_14 = PUxNWIO_14)

SIO_11 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_11_EBSA-GIS shapefile/SIO_11_EBSA.shp"
PUxSIO_11 <- fSpatPlan_Get_Polyg(SIO_11, PUs)  
PUs <- PUs %>% 
  mutate(SIO_11 = PUxSIO_11)

SIO_19 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_19_EBSA-GIS%20shapefile/SIO_19_EBSA.shp"
PUxSIO_19 <- fSpatPlan_Get_Polyg(SIO_19, PUs)  
PUs <- PUs %>% 
  mutate(SIO_19 = PUxSIO_19)

SIO_22 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_22_EBSA-GIS shapefile/SIO_22_EBSA.shp"
PUxSIO_22 <- fSpatPlan_Get_Polyg(SIO_22, PUs)  
PUs <- PUs %>% 
  mutate(SIO_22 = PUxSIO_22)

SIO_23 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_23_EBSA-GIS shapefile/SIO_23_EBSA.shp"
PUxSIO_23 <- fSpatPlan_Get_Polyg(SIO_23, PUs)  
PUs <- PUs %>% 
  mutate(SIO_23 = PUxSIO_23)

SIO_30 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_30_EBSA-GIS shapefile/SIO_30_EBSA.shp"
PUx_SIO30 <- fSpatPlan_Get_Polyg(SIO_30, PUs)  
PUs <- PUs %>% 
  mutate(SIO_30 = PUx_SIO30)

SIO_32 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_32/SIO_32_EBSA.shp"
PUxSIO_32 <- fSpatPlan_Get_Polyg(SIO_32, PUs)  
PUs <- PUs %>% 
  mutate(SIO_32 = PUxSIO_32)

SIO_35<- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_35_EBSA-GIS shapefile/SIO_35_EBSA.shp"
PUxSIO_35 <- fSpatPlan_Get_Polyg(SIO_35, PUs)  
PUs <- PUs %>% 
  mutate(SIO_35 = PUxSIO_35)

SIO_36 <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_36_EBSA-GIS shapefile/SIO_36_EBSA.shp"
PUxSIO_36 <- fSpatPlan_Get_Polyg(SIO_36, PUs)  
PUs <- PUs %>% 
  mutate(SIO_36 = PUxSIO_36)

SIO_37  <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_37_EBSA-GIS shapefile/SIO_37_EBSA.shp"
PUx_SIO37 <- fSpatPlan_Get_Polyg(SIO_37 , PUs)  
PUs <- PUs %>% 
  mutate(SIO_37 = PUx_SIO37)
```

### Deep-sea features

Seamounts, plateaus, inactive + active vents

+ Active + inactive vents: 70% [.csv to .shp](https://datacarpentry.org/r-raster-vector-geospatial/10-vector-csv-to-shapefile-in-r/) [dataset  datum](https://vents-data.interridge.org/sites/vents-data.interridge.org/files/InterRidge_Vents_Database_Version3.1_documentation.pdf)
+ Seamounts: 30% (but some advocate for more: Letessier et al., 2019, PLOS Biology)
+ Plateaus: 30%


```{r Deep-sea features, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}
Seamounts <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/BlueHabs/Seamounts.shp"
PUxSeamounts <- fSpatPlan_Get_Polyg(Seamounts, PUs)  
PUs <- PUs %>% 
  mutate(Seamounts = PUxSeamounts)

Plateaus <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/BlueHabs/Plateaus.shp"
PUxPlateaus <- fSpatPlan_Get_Polyg(Plateaus, PUs)  
PUs <- PUs %>% 
  mutate(Plateaus = PUxPlateaus)

Vents <- read.csv("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/vents.csv")
VentsActive <- filter(Vents, Activity == "active, confirmed" | Activity == "active, inferred") 
VentsActiveSF <- st_as_sf(VentsActive, coords = c(x = "Longitude", y = "Latitude"), crs = 4326) %>% 
  st_transform(cCRS)

PUxVentsActive <- st_contains(PUs,VentsActiveSF, sparse = FALSE) %>%
  rowSums() %>% 
  as.logical()
PUs <- PUs %>% 
  mutate(Active_Vents = PUxVentsActive)

VentsInactive <- filter(Vents, Activity == "inactive")
VentsInactiveSF <- st_as_sf(VentsActive, coords = c(x = "Longitude", y = "Latitude"), crs = 4326) %>% 
  st_transform(cCRS)

PUxVentsInactive <- st_contains(PUs,VentsInactiveSF, sparse = FALSE) %>%
  rowSums() %>% 
  as.logical()
PUs <- PUs %>% 
  mutate(Inactive_Vents = PUxVentsInactive)

```

```{r vents plot, echo = FALSE, message = FALSE, warning = FALSE}
world <- ne_countries(scale = "medium", returnclass = "sf")
IndianO <- c(xmin = 17.47941, ymin = -38.7402, xmax = 129.552, ymax = 33.82872)

ggplot() + 
  geom_sf(data = world) + 
  geom_sf(data = VentsActiveSF) +
  ggtitle("Active vents after st_tranform(cCRS)") +
  coord_sf(xlim = c(IndianO[["xmin"]], IndianO[["xmax"]]), ylim = c(IndianO[["ymin"]], IndianO[["ymax"]]), expand = FALSE) 

#PUxVents <- st_join(PUs, VentsActiveSF, join = st_within) #no longer needed
#VentsActiveSFClean <- dplyr::select(VentsActiveSF, Name.ID, geometry)
#VentsActiveSFCleanBuff <- st_buffer(VentsActiveSFClean, dist = 1000)
#PUxVents <- st_intersects(VentsActiveSF, PUs)
#PUs <- PUs %>% 
#  mutate(Vents = PUxVents)
  
```


```{r Conservation features, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}

IMMA <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/IMMAs/iucn-imma.shp")
IBA <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/IBAs/MarineIBA_IndianOcean.shp")
NEIO_09<- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/NEIO_9_EBSA/NEIO_9_EBSA.shp")
NWIO_14 <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/NWIO_14_EBSA/NWIO_14_EBSA.shp")
SIO_11 <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_11_EBSA-GIS shapefile/SIO_11_EBSA.shp")
SIO_19 <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_19_EBSA-GIS%20shapefile/SIO_19_EBSA.shp")
SIO_22 <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_22_EBSA-GIS shapefile/SIO_22_EBSA.shp")
SIO_23 <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_23_EBSA-GIS shapefile/SIO_23_EBSA.shp")
SIO_30 <- st_read  ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_30_EBSA-GIS shapefile/SIO_30_EBSA.shp")
SIO_32 <- st_read  ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_32/SIO_32_EBSA.shp")
SIO_35<- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_35_EBSA-GIS shapefile/SIO_35_EBSA.shp")
SIO_36 <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_36_EBSA-GIS shapefile/SIO_36_EBSA.shp")
SIO_37  <-st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/EBSAs/SIO_37_EBSA-GIS shapefile/SIO_37_EBSA.shp")
Seamounts <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/BlueHabs/Seamounts.shp")
Plateaus <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Biodiv_features/BlueHabs/Plateaus.shp")
```

Conservation features

```{r Conservation features plot, echo = FALSE, message = FALSE, warning = FALSE}

ggplot() + 
  geom_sf(data = world) +
  geom_sf(data = NEIO_09,  aes(color="A"), show.legend = "line")+ 
  geom_sf(data = NWIO_14,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_11,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_19,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_22,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_23,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_30,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_32,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_35,  aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_36, aes(color="A"), show.legend = "line")+
  geom_sf(data = SIO_37,  aes(color="A"), show.legend = "line")+
  geom_sf(data = Seamounts,  aes(color="B"), show.legend = "line")+
  geom_sf(data = Plateaus,  aes(color="C"), show.legend = "line")+
  geom_sf(data = IBA,  aes(color="D"), show.legend = "line") + 
  geom_sf(data = IMMA,  aes(color="E"), show.legend = "line")+ 
  geom_sf(data = VentsActiveSF,  aes(color="F"), show.legend = "line")+
  geom_sf(data = VentsInactiveSF,  aes(color="G"), show.legend = "line")+
  ggtitle("IBA, IMMA, EBSAs, Seamounts, Plateaus, Vents")+ 
  coord_sf(xlim = c(IndianO[["xmin"]], IndianO[["xmax"]]), ylim = c(IndianO[["ymin"]], IndianO[["ymax"]]), expand = FALSE)+
  scale_color_manual(values = c("A" = "grey", "B" = "black", "C" = "blue", "D" = "green", "E" = "purple", "F" = "red", "G" = "brown"), 
                     labels = c("EBSAs", "Seamounts", "Plateaus", "IBAs", "IMMAs", "Active vents", "Inactive Vents"),
                     name = "Legend") 

```
### Targets dataframe

Cons_feats <- tibble(Features = c("IBA", "IMMA", "NEIO_09", "NWIO_14", "SIO_11", "SIO_19", "SIO_22", "SIO_23", "SIO_30", "SIO_32", "SIO_35", "SIO_36", "SIO_37","Seamounts", "Plateaus", "Active_Vents", "Inactive_Vents"), Targets = c(0.3, 0.3, 0.3, 0.3, 0.3, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.3, 0.3, 0.7, 0.7))

## Cost layer

Composed of 

+ PMN and CFC areas (Sharma, 2011 for USD valuation)
+ Exploration & reserved areas of deep-sea mining (lock out because won't agree to lose investments)
+ Fishing effort (using ready-made cost layer in Spatial Planning repo)
+ Shipping routes (use value of cell in Halpern et al. (2015), 2013 dataset for relative cost)

Need to define how to combine these costs into 1 layer. Mult-C Sync software (Moffett et al., 2005  / Cameron et al., 2008)? 

Or: running multiple prioritization problems and defining **no-regret** MPAs across stakeholders. 

### CFC

Cobalt-rich Ferromanganese Crusts. Still researching how to value.

```{r CFC, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}
CFC <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_resources/Crust/Crust_areas_Hein2013.shp" 
PUxCFC <- fSpatPlan_Get_Polyg(CFC, PUs)  # function returns out as a logical vector
PUs <- PUs %>% 
  mutate(CFC = PUxCFC) # Add logical vector to variable
```

### PMN

Areas rich in PolyMetallic Nodules. **Monetary value** could be assigned using:

+ density: 5.6kg/sqm in Indian Ocean basin (Sharma, 2011) - an approximation but better than nothing?
[link](https://www.resolve.ngo/docs/mar_technol_soc_j_45_28a.pdf)
+ value: 320-1,100USD/tonne of nodules (CRU Consulting, 2019) [link](https://isa.org.jm/files/files/documents/CRU_ISA%20Polymetallic%20nodule%20valuation%20report_24Aug2020.pdf)
+ size of PMN area: #of PUs that intersect with PMN layer * PU size (1000sqkm)
+ extraction rate: 1.5Mt/yr for 20 yrs (Sharma, 2011) (but using this brings even greater uncertainty, I think)

```{r PMN, echo = TRUE,  results = "hide", message = FALSE, warning = FALSE}
PMN <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_resources/Nodules/Nodules_Hein2013.shp"
PUxPMN <- fSpatPlan_Get_Polyg(PMN, PUs)  
PUs <- PUs %>% 
  mutate(PMN = PUxPMN)
```

### Exploration areas 

We need to **lock out** those areas, as mining companies have invested heavily into exploration and will not agree to lose access.

```{r expl, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}
ExplPMN <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/01_pmn_exploration_areas.shp"
PUxExplPMN <- fSpatPlan_Get_Polyg(ExplPMN, PUs)  
PUs <- PUs %>% 
  mutate(ExplPMN = PUxExplPMN)

ExplPMS <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/02_pms_exploration_areas.shp"
PUxExplPMS <- fSpatPlan_Get_Polyg(ExplPMS, PUs)  
PUs <- PUs %>% 
  mutate(ExplPMS = PUxExplPMS)

ExplCFC <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/03_cfc_exploration_areas.shp"
PUxExplCFC <- fSpatPlan_Get_Polyg(ExplCFC, PUs)  
PUs <- PUs %>% 
  mutate(ExplCFC = PUxExplCFC)
```

### Reserved areas 

Areas reserved for mining exploitation by developing countries - can also be locked out (same reasoning as above).

```{r res, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}
ResPMN <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/04_pmn_reserved_areas.shp"
PUxResPMN <- fSpatPlan_Get_Polyg(ResPMN, PUs)  
PUs <- PUs %>% 
  mutate(ResPMN = PUxResPMN)

ResCFC <- "~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/05_cfc_reserved_areas.shp"
PUxResCFC <- fSpatPlan_Get_Polyg(ResCFC, PUs)  
PUs <- PUs %>% 
  mutate(ResCFC = PUxResCFC)
```

```{r Mining layer, echo = FALSE, message = FALSE, warning = FALSE, results = "hide"}
world <- ne_countries(scale = "medium", returnclass = "sf")
IndianO <- c(xmin = 17.47941, ymin = -38.7402, xmax = 129.552, ymax = 33.82872)
CFC <- st_read("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_resources/Crust/Crust_areas_Hein2013.shp")
PMN <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_resources/Nodules/Nodules_Hein2013.shp")
Expl_PMN <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/01_pmn_exploration_areas.shp")
Expl_PMS <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/02_pms_exploration_areas.shp")
Expl_CFC <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/03_cfc_exploration_areas.shp")
Res_PMN <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/04_pmn_reserved_areas.shp")
Res_CFC <- st_read ("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Mining_contractors/ContractorAreas/05_cfc_reserved_areas.shp")
```

Mining areas

```{r Mining layer plot, echo = FALSE, message = FALSE, warning = FALSE}
ggplot() + 
  geom_sf(data = world) +
  geom_sf(data = CFC, aes(color="A"), show.legend = "line") + 
  geom_sf(data = PMN, aes(color="B"), show.legend = "line") + 
  geom_sf(data = Expl_PMN, aes(color="C"), show.legend = "line") + 
  geom_sf(data = Expl_PMS, aes(color="D"), show.legend = "line") +
 # geom_sf(data = Expl_CFC, aes(color="E"), show.legend = "line") +
  geom_sf(data = Res_PMN, aes(color="F"), show.legend = "line") +
 # geom_sf(data = Res_CFC, aes(color="G"), show.legend = "line") +
  scale_color_manual(values = c("A" = "grey", "B" = "brown", "C" = "orange", "D" = "red", "F" = "yellow"), 
                     labels = c("CFC", "PMN", "Expl_PMN", "Expl_PMS", "Res_PMN"),
                     name = "Legend") +
  ggtitle("PMN, CFC, Exploration & Reserved areas") + 
  coord_sf(xlim = c(IndianO[["xmin"]], IndianO[["xmax"]]), ylim = c(IndianO[["ymin"]], IndianO[["ymax"]]), expand = FALSE)

```

## Shipping

Overlay shipping raster with polygons to get average intensity of shipping for 1 PU.


```{r Shipping plot, echo = FALSE}
Shipping <- terra::rast("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Shipping/shipping.tif")
plot(Shipping, main = 'Shipping routes')

#ShippingRobin <- terra::
#exactextractr::exact_extract(Shipping, PUs, mean)
```


```

ShippingCost <- terra::rast("~/Documents/MscThesis/GitHub/SpatialPlanning/Shp/Costs/Shipping/shipping.tif") %>% 
    terra::as.polygons(trunc = FALSE, dissolve = FALSE, na.rm=FALSE) %>% # Convert to polygon data
    st_as_sf() %>% # Convert to sf
    st_transform(cCRS) %>% # Transform to projection
    st_interpolate_aw(PUs, extensive = FALSE) %>% ## intersect with PUs
    rename(ShippingCost = layer)
```

## Fishing

Could set cut-off for cost outliers at 15,000 USD or 40,000 USD or no cut off - depending on whether we want to favour variation or follow standard procedures for outliers (see histograms and maps).


```{r Fishing cost, echo = TRUE, warning = FALSE}

#adding modified fx here to ensure it uses the right path

fSpatPlan_Get_Cost <- function(PUs, cCRS){
  
  # TODO Add some filtering ability to get the cost only for specific groups
  
  FishingCost <- terra::rast("Data/Cost/Cost_Raster_Sum.grd") %>% 
    terra::as.polygons(trunc = FALSE, dissolve = FALSE, na.rm=FALSE) %>% # Convert to polygon data
    st_as_sf() %>% # Convert to sf
    st_transform(cCRS) %>% # Transform to robinson
    st_interpolate_aw(PUs, extensive = FALSE) %>% ## intersect with PUs
    rename(FishingCost = layer)
}

FishingCost <- fSpatPlan_Get_Cost(PUs, cCRS)

hist(FishingCost$FishingCost) #max value >200,000
FishingCostPlusOne <- FishingCost$FishingCost + 1
hist(log10(FishingCostPlusOne)) #drop after log10(x)=4, x=10^4=10,000?

ggplot() + 
  geom_sf(data = world) +
  geom_sf(data = FishingCost, aes(color=FishingCost)) +
ggtitle("Fishing Cost All Values") + 
  coord_sf(xlim = c(IndianO[["xmin"]], IndianO[["xmax"]]), ylim = c(IndianO[["ymin"]], IndianO[["ymax"]]), expand = FALSE)

```

```
FishingCostOutliers <- filter(FishingCost, Cost >= 22000) # check outliers

hist(FishingCostOutliers$Cost)

ggplot() + 
  geom_sf(data = world) +
  geom_sf(data = FishingCostOutliers, aes(color=Cost)) +
ggtitle("Fishing Cost Outliers (>50,000 USD)") + 
  coord_sf(xlim = c(IndianO[["xmin"]], IndianO[["xmax"]]), ylim = c(IndianO[["ymin"]], IndianO[["ymax"]]), expand = FALSE)

FishingCostNoOutliers <- filter(FishingCost, Cost <= 22000) # remove outliers

hist(FishingCostNoOutliers$Cost) #(49256 obs. = 524 outliers removed when #cut-off = 20,000)

ggplot() + 
  geom_sf(data = world) +
  geom_sf(data = FishingCostNoOutliers, aes(color=Cost)) +
ggtitle("Fishing Cost Without Outliers") + 
  coord_sf(xlim = c(IndianO[["xmin"]], IndianO[["xmax"]]), ylim = c(IndianO[["ymin"]], IndianO[["ymax"]]), expand = FALSE)
  
```

# Prioritizr problems

## Basic run (Cons features)

*Code based on Alvise's work, not as code here to avoid issues when knitting*

```
p_ConsFeats <- problem(PUs, Cons_feats$Features, cost_column = "NoCost") %>%
  add_min_set_objective() %>%
  add_relative_targets(Cons_Feats$Targets) %>% #
  add_binary_decisions() %>%
  add_lpsymphony_solver(verbose = FALSE) #%>%

````

### Cons features, fishing

*Assumes targets (ConsFeatures$amount) are set, code based on Alvise's work, not as code here to avoid issues when knitting*

```
p_ConsFeat_Fishing <- problem(PUs, features = ConsFeatures, cost_column = "FishingCost") %>% 
  add_min_set_objective() %>% 
  add_relative_targets(ConsFeatures$amount) %>% # representation targets (Area)
  add_binary_decisions() %>%
  add_lpsymphony_solver(verbose = FALSE) #%>%
```

### Cons features, mining

*Assumes targets (ConsFeatures$amount) are set, code based on Alvise's work, not as code here to avoid issues when knitting*

*PMNCost will probably be created based on Sharma (2011) & CRU Consulting (2019)?*

[prioritizr.net](https://prioritizr.net/reference/add_locked_out_constraints.html) says to use structure below to lock out polygons but need to look more into it

```
# create problem with added locked out constraints using spatial polygon data
locked_out <- sim_pu_polygons[sim_pu_polygons$locked_out == 1, ]
p5 <- p1 %>% add_locked_out_constraints(locked_out)
```

```

p_ConsFeat_Mining <- problem(PUs, features = ConsFeatures, cost_column = "PMNCost") %>% 
  add_min_set_objective() %>% 
  add_relative_targets(ConsFeatures$amount) %>% # representation targets (Area)
  add_binary_decisions() %>%
  add_lpsymphony_solver(verbose = FALSE) #%>%
  add_locked_out_constraints("Expl_CFC", "Expl_PMN", "Expl_PMS", "Res_PMN", "Res_CFC")
```

### Cons features, mining + fishing

*Assumes targets (ConsFeatures$amount) are set, code based on Alvise's work, not as code here to avoid issues when knitting*

```

p_ConsFeat_MiningFishing <- problem(PUs, features = ConsFeatures, cost_column = "MiningFishing") %>% 
  add_min_set_objective() %>% 
  add_relative_targets(ConsFeatures$amount) %>% # representation targets (Area)
  add_binary_decisions() %>%
  add_lpsymphony_solver(verbose = FALSE) #%>%
  add_locked_out_constraints("Expl_CFC", "Expl_PMN", "Expl_PMS", "Res_PMN", "Res_CFC")
```

### Cons features, shipping


*Same as p_ConsFeat_MiningFishing but with shipping routes locked out as well* 

*Not sure what kind of data transformation is needed to have a file with present/absent shipping routes* 

*Or we can try estimating cost of shipping (question at start of .rmd) and combining with other costs into 1 layer*

```

p_ConsFeat_Shipping <- problem(PUs, features = ConsFeatures, cost_column = "MiningFishing") %>% 
  add_min_set_objective() %>% 
  add_relative_targets(ConsFeatures$amount) %>% # representation targets (Area)
  add_binary_decisions() %>%
  add_lpsymphony_solver(verbose = FALSE) #%>%
  add_locked_out_constraints("Shipping","Expl_CFC", "Expl_PMN", "Expl_PMS", "Res_PMN", "Res_CFC")
```

# Discussion

## Potential improvements

# Conclusion